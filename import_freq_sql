
if [[ "$1" == "" ]]; then
  echo USAGE: import_freq BOOK_ID
  echo Creates a temp file with SQL instructions that will import
  echo from STDIN data with text lines in the form "{a,b,c,d} 100"
  exit -1
fi

SQLFILE=$(tempfile)

cat <<-'---' | sed "s/#BOOK_ID#/$1/g" >"$SQLFILE"
BEGIN TRANSACTION;

CREATE TEMP TABLE tmp_ngrams_freq (
  gram TEXT[],
  freq INTEGER NOT NULL DEFAULT 1
) ON COMMIT DROP;

\COPY tmp_ngrams_freq FROM pstdin DELIMITER ' ';

-- Insert all ngrams; duplicates will be ignored by rule
INSERT INTO ngrams (n, gram)
SELECT array_length(gram, 1), gram FROM tmp_ngrams_freq;

-- If the book's frequencies already exist, remove them
UPDATE frequencies AS f
SET freq = f.freq - g.freq
FROM frequencies AS g
WHERE f.book_id = 0 AND g.book_id = #BOOK_ID# AND f.ngram_id = g.ngram_id;

DELETE FROM frequencies
WHERE book_id = #BOOK_ID#;

-- Insert frequencies for this book
INSERT INTO frequencies (book_id, ngram_id, freq)
SELECT #BOOK_ID#, g.id, freq
FROM tmp_ngrams_freq t
INNER JOIN ngrams g ON g.n = array_length(t.gram, 1) AND g.gram = t.gram
WHERE g.id IS NOT NULL;

UPDATE frequencies AS f
SET freq = f.freq + g.freq
FROM frequencies AS g
WHERE f.book_id = 0 AND g.book_id = #BOOK_ID# AND f.ngram_id = g.ngram_id;

COMMIT;
---

echo $SQLFILE
